#!/bin/bash


sleep_dr() { sleep `printf "%d.%02d" $(( (RANDOM % 3) + 2 )) $(( RANDOM % 100 ))` ;}


apt_src() {
	local deb_file=/etc/apt/sources.list
	local rpi_file=/etc/apt/sources.list.d/raspi.list

	printf "Backing up prev src lists..."
	if [ $dry_run == true ]; then sleep_dr
	else
		[ -f "$deb_file" ] && sudo cp $deb_file $deb_file.bak
		[ -f "$rpi_file" ] && sudo cp $rpi_file $rpi_file.bak
	fi
	echo

	printf "Uncommenting deb-src..."
	if [ $dry_run == true ]; then sleep_dr
	else
		sudo sed -Ei 's/#Uncomment/\n#Uncomment/g' $deb_file
		sudo sed -Ei 's/#deb-src/deb-src/g' $deb_file

	fi
	if [ $dry_run == true ]; then sleep_dr
	else
		sudo sed -Ei 's/#Uncomment/\n#Uncomment/g' $rpi_file
		sudo sed -Ei 's/#deb-src/deb-src/g' $rpi_file
	fi
	echo ; echo
}


apt_upg() {
    printf "Updating & upgrading apt...\n"
    if [ $dry_run == true ]; then sleep_dr
    else
        sudo apt update
        sudo apt upgrade -y
    fi
    echo
}


apt_inst() {
    local pkgs="bc exfat-utils git hfsutils jq pv source-highlight sysbench tmux wget"

    printf "Installing packages:\n"
    echo $pkgs | awk -F\  '{printf "%-30s\n",$0}'
    if [ $dry_run == true ]; then sleep_dr
    else
        sudo apt install -y $pkgs
    fi
    echo
}


apt_cleanup() {
    printf "Autocleaning & autoremoving...\n"
    if [ $dry_run == true ]; then sleep_dr
    else
        sudo apt autoremove -y
        sudo apt autoclean -y
    fi
    echo
}


$dry_run=false
[ ! -z $1 && $1 == "true" ] && $dry_run=true


echo $dry_run ; exit 0;


clear
printf "Enabling deb-src packages in sources.list:\n"
apt_src

printf "Updating & upgrading apt:\n"
apt_upg

printf "\nInstalling preliminary packages:\n"
apt_inst

printf "\nAuto removing & cleaning:\n"
apt_cleanup

read -n 1 -s -r -p "\nSetup complete!, press any key to reboot..."


exit 0;


